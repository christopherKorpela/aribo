<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<script type="text/javascript" src="javascript/easeljs.min.js"></script>
<script type="text/javascript" src="javascript/eventemitter2.min.js"></script>
<script type="text/javascript" src="javascript/roslib.min.js"></script>
<script type="text/javascript" src="javascript/mjpegcanvas.min.js"></script>
<script type="text/javascript" src="javascript/ros2d.min.js"></script>
<script type="text/javascript" src="javascript/nav2d.js"></script>

    <link href="css/bootstrap.min.css" rel="stylesheet">

<link href="css/style.css" rel="stylesheet">

    <script type="text/javascript" type="text/javascript">
    function getParam(name)
    {  
        name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");  
        var regexS = "[\\?&]"+name+"=([^&#]*)";  
        var regex = new RegExp( regexS );  
        var results = regex.exec(window.location.href);
        if(results == null)
            return "";  
        else    
            return results[1];
    }

  var ip = getParam('ip');
  var state = "teleop";
  var ros = new ROSLIB.Ros({
url : 'ws://'+ip+':9090'
});

ros.on('connection', function() {
    console.log('Connected to websocket server.');
    });

ros.on('error', function(error) {
    console.log('Error connecting to websocket server: ', error);
    });

ros.on('close', function() {
    console.log('Connection to websocket server closed.');
    });

// command states that are listened in on
var cmdVel = new ROSLIB.Topic({
ros : ros,
name : '/teleop',
messageType : 'geometry_msgs/Twist'
});

// splits the publish based on different window sides
function twistPublish(dx,dy,bx,by)
{
  twist = new ROSLIB.Message({
linear : {
x : dy,
y : 0,
z : 0
},
angular : {
x : 0,
y : 0,
z : dx
}
});

cmdVel.publish(twist);
}

window.onresize = function(event) {
  generateHTML();
  generateSizes();
}



// regenerate html whenever something on the screen changes
function generateHTML(){
  cont = document.getElementById("content").getElementsByTagName("td");
  width = document.getElementById("wd").offsetWidth;

  if (width >= 1280)
  {
    cont[0].height=480;
    cont[0].width=640;
    cont[1].height=480;
    cont[1].width=640;
  }
  else
  {
    if(width>=640) {width=640;}
    cont[0].height=width*2/3;
    cont[0].width=width;
    cont[1].height=0;
    cont[1].width=0;
  }
}

// regenerate the smaller elements whenever something changes
function generateSizes(){
  width = document.getElementById("wd").offsetWidth;
  mjpegEle = document.getElementById("mjpeg").getElementsByTagName("canvas")[0];

  mjpegEle.height=width*2/3;
  mjpegEle.width=width;
}


// Functions to load assets
function loadTeleop()
{
  loadJoy();
  state = "teleop";
  generateHTML();
  generateSizes();
}


function init(){
  // Create the main viewer.
  camera_viewer = new MJPEGCANVAS.Viewer({
divID : 'mjpeg',
host : ip, 
width : 640,
height : 480,
quality: 10,
topic : '/camera/image_color'
});

var twist = new ROSLIB.Message({
linear : {
x : 0,
y : 0,
z : 0
},
angular : {
x : 0,
y : 0,
z : 0
}
});

cmdVel.publish(twist);

loadTeleop();
generateHTML();
generateSizes();

}


</script>

</head>

<body onload="init()">
<script src="javascript/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<div class="tab-content">
<div class="tab-pane active" id="lA">

<div id="content">


<div id="container">
<table><tr>
<td height=0 width=0><div id="mjpeg"></div><span id="result"></span></td>
</tr></table>


</div>
</div>
</div>

<script src="virtualjoystick.js"></script>
<script>
function loadJoy(){
  console.log("touchscreen is", VirtualJoystick.touchScreenAvailable() ? "available" : "not available");
  joystick	= new VirtualJoystick({
container	: document.getElementById('content'),
mouseSupport	: true,
ytrans		: -0.0
});
joystick.addEventListener('touchStart', function(){
    console.log('down')
    })
joystick.addEventListener('touchEnd', function(){
    console.log('up')
    })

setInterval(function(){
    twistPublish(-joystick.deltaX(),-joystick.deltaY(),joystick._baseX,joystick._baseY);
    }, 1/10 * 1000);
}

function destroyJoy(){
  joystick.destroy();
}

</script>
</body>
</html>
