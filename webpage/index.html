<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <script type="text/javascript" src="javascript/easeljs.min.js"></script>
        <script type="text/javascript" src="javascript/eventemitter2.min.js"></script>
        <script type="text/javascript" src="javascript/roslib.min.js"></script>
        <script type="text/javascript" src="javascript/mjpegcanvas.min.js"></script>
        <script type="text/javascript" src="javascript/ros2d.min.js"></script>
        <script type="text/javascript" src="javascript/nav2d.js"></script>
        
        <link href="css/bootstrap.min.css" rel="stylesheet">
        
        <link href="css/style.css" rel="stylesheet">

        <script type="text/javascript" src="config.js"></script> 
        <script type="text/javascript" type="text/javascript">
        var map;

        function getParam(name)
        {  
            name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");  
            var regexS = "[\\?&]"+name+"=([^&#]*)";  
            var regex = new RegExp( regexS );  
            var results = regex.exec(window.location.href);
            if(results == null)
                return "";  
            else    
                return results[1];
        }
        
        // would like to have the IP parameter set in a launch file
        
        var ros = new ROSLIB.Ros({
        url : 'ws://'+ip+':9090'
        });
        
        ros.on('connection', function() {
                console.log('Connected to websocket server.');
                });
        
        ros.on('error', function(error) {
                console.log('Error connecting to websocket server: ', error);
                });
        
        ros.on('close', function() {
                console.log('Connection to websocket server closed.');
                });

        
        window.onresize = function(event) {
            generateHTML();
        }

        // regenerate html whenever something on the screen changes
        function generateHTML(){
            var mjpegEle = document.getElementById("mjpeg").getElementsByTagName("img")[0];
            var mapEle = document.getElementById("map");
            var cont = document.getElementById("content").getElementsByTagName("td");
            var width = document.body.offsetWidth;
        
            if (width >= 1380)
            {
                cont[0].height=480;
                cont[0].width=640;
                cont[1].height=480;
                cont[1].width=640;
                cont[2].height=480;
                cont[2].width=100;
                mjpegEle.height=480;
                mjpegEle.width=640;
            }
            else
            {
                width = width - 100;
                if(width>=640) {width=640;}
                cont[0].height=width*2/3;
                cont[0].width=width;

                cont[1].height=width*2/3;
                cont[1].width=width;

                cont[2].height=480;
                cont[2].width=100;

                mjpegEle.height=width*2/3;
                mjpegEle.width=width;
            }
            google.maps.event.trigger(map, 'resize');
        }

        function applyNS(ns, v){
          if(v.charAt(0)=="/"){
            return v;
          }else{
            return "/"+ns+"/"+v;
          }
        }
        
        function init(){
            imageFeed();
            generateHTML();

            sensorHTML = "";
            var listeners = [];
            var subFuncs = [];

            for (i = 0; i < sensorList.length; i++) {
              sensorHTML += '<a href="#" id="';
              sensorHTML += sensorList[i];
              sensorHTML += '" class="list-group-item list-group-item-success">';
              sensorHTML += sensorList[i];
              sensorHTML += '</a>';


              listeners[i] = new ROSLIB.Topic({
                ros : ros,
                name : applyNS(sensorNamespace,sensorList[i]),
                messageType : 'std_msgs/Float64'
              });
              subFuncs[i] = sensorCb.bind(null, i);

              listeners[i].subscribe( subFuncs[i] );
            }
            document.getElementById("sensor_listing").innerHTML = sensorHTML;
        }
        
        function gpsFeed() {
          var starting_center = new google.maps.LatLng(52.3702157, 4.8951679);
          var mapOptions = {
            center: starting_center,
            zoom: 18,
            mapTypeId: google.maps.MapTypeId.HYBRID
          }
          map = new google.maps.Map(document.getElementById("map"), mapOptions);
        
          var marker = new google.maps.Marker({
            position: starting_center,
            map: map
          });

          gps_sub = new ROSLIB.Topic({
            ros : ros,
            name : applyNS(sensorNamespace,gpsTopic),
            messageType : 'sensor_msgs/NavSatFix'
          });

          gps_sub.subscribe(gpsCb.bind(null, map, marker));
        }

        function gpsCb(map, marker, msg){
          var new_center = new google.maps.LatLng(msg.latitude, msg.longitude);
          map.panTo(new_center);
          map.setCenter(new_center);
          marker.setPosition(new_center);
        }
        
        function imageFeed() {
          img_html="<img src=\"http://"+ip+":"+web_socket_port;
          img_html+="/stream?topic="+applyNS(sensorNamespace,imageTopic)+"\"></img>";
          img_html+="\"\\>";
        
          img = document.getElementById("mjpeg");
          img.innerHTML = img_html;
        }
        
        function sensorCb(ij, message) {
          console.log('arguments.length ' + arguments.length );
          for( i = 0; i < arguments.length; i++)
          {
              console.log( i + ':::' + arguments[i] );
          }
          temp = document.getElementById(sensorList[ij]);
          cn = "list-group-item list-group-item-";
          if( dangerMin[ij] <= message.data )
          {
            cn += "danger";
          }
          else if( warningMin[ij] <= message.data )
          {
            cn += "warning";
          }
          else
          {
            cn += "success";
          }
          temp.className = cn;
          temp.innerHTML= sensorList[ij] + "::" + Math.round(message.data*10)/10;
        }
        
        </script>
        
    </head>

    <body onload="init()">
        <script src="javascript/jquery.min.js"></script>
        <script src="js/bootstrap.min.js"></script>
        <div class="tab-content">
          <div class="tab-pane active" id="lA">
            <div id="content">
              <div id="container">
                <table><tr>
                  <td height=0 width=0>
                    <div id="mjpeg"></div>
                    <span id="result"></span>
                  </td>

                  <td height=100 width=100>
                    <div id="map" style="height:100%"></div>
                  </td>

                  <td height=120 width=30>

                    <div class="list-group" id="sensor_listing">
                    </div>

                  </td>

                </tr></table>
              </div>
            </div>
          </div>
        </div>


    <script>
    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCuNBNktLtyOfnruUEEsnNB7ALxvoce_OI&callback=gpsFeed" async defer></script>

    </body>
</html>
